#include <openssl/bn.h>
#include <openssl/ec.h>
#include <openssl/err.h>

//#include "../smcrypto_err.h"
#include "sm/smcrypto_err.h"

#ifdef EC_SM2_PRIME_256V1
/* SM2 PRIME 256V1 */
#define _P  "FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF"
#define _a  "FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC"
#define _b  "28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93"
#define _n  "FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123"
#define _Gx "32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7"
#define _Gy "BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0"
#else
/* SM2 testing P256 Vetor*/
#define _P  "8542D69E4C044F18E8B92435BF6FF7DE457283915C45517D722EDB8B08F1DFC3"
#define _a  "787968B4FA32C3FD2417842E73BBFEFF2F3C848B6831D7E0EC65228B3937E498"
#define _b  "63E4C6D3B23B0C849CF84241484BFE48F61D59A5B16BA06E6E12D1DA27C5249A"
#define _Gx "421DEBD61B62EAB6746434EBC3CC315E32220B3BADD50BDC4C4E6C147FEDD43D"
#define _Gy "0680512BCBB42C07D47349D2153B70C4E5D7FDFCBFA36EA1A85841B9E46E09A2"
#define _n  "8542D69E4C044F18E8B92435BF6FF7DD297720630485628D5AE74EE7C32E79B7"
#endif

EC_KEY* SM2_gen_key()
{
    int ret = 0;
    EC_KEY* key = NULL;
    BN_CTX *ctx = NULL;
    EC_GROUP* group = NULL;
    EC_POINT* point_p = NULL;
    BIGNUM *p = NULL, *a = NULL, *b = NULL, *gx = NULL, *gy = NULL, *z = NULL;

    group = EC_GROUP_new(EC_GFp_mont_method());
    SM_ERROR_ESCAPE(group == NULL, SM_F_SM2_GEN_KEY, SM_R_EC_GROUP_NEW_FAILED, 0);

    BN_hex2bn(&p, _P);
    BN_hex2bn(&a, _a);
    BN_hex2bn(&b, _b);
    BN_hex2bn(&gx, _Gx);
    BN_hex2bn(&gy, _Gy);
    BN_hex2bn(&z, _n);
    SM_ERROR_ESCAPE(p == NULL || a == NULL || b == NULL || gx == NULL || gy == NULL || z == NULL, SM_F_SM2_GEN_KEY, SM_R_BN_HEX2BN_FAILED, 0);

    ctx = BN_CTX_new();
    SM_ERROR_ESCAPE(ctx == NULL, SM_F_SM2_GEN_KEY, SM_R_BN_CTX_NEW_FAILED, 0);

    ret = EC_GROUP_set_curve_GFp(group, p, a, b,ctx);
    SM_ERROR_ESCAPE(ret == 0, SM_F_SM2_GEN_KEY, SM_R_EC_GROUP_SET_CURVE_GFP_FAILED, 0);

    point_p = EC_POINT_new(group);
    SM_ERROR_ESCAPE(point_p == NULL, SM_F_SM2_GEN_KEY, SM_R_EC_POINT_NEW_FAILED, 0);

    ret = EC_POINT_set_affine_coordinates_GFp(group, point_p, gx, gy, ctx);
    SM_ERROR_ESCAPE(ret == 0, SM_F_SM2_GEN_KEY, SM_R_EC_POINT_SET_AFFINE_COORDINATES_GFP_FAILED, 0);

    ret = EC_POINT_is_on_curve(group, point_p, ctx);
    SM_ERROR_ESCAPE(ret == 0, SM_F_SM2_GEN_KEY, SM_R_EC_POINT_IS_ON_CURVE_FAILED, 0);

    ret = EC_GROUP_set_generator(group, point_p, z, BN_value_one());
    SM_ERROR_ESCAPE(ret == 0, SM_F_SM2_GEN_KEY, SM_R_EC_GROUP_SET_GENERATOR_FAILED, 0);

    key = EC_KEY_new();
    SM_ERROR_ESCAPE(key == NULL, SM_F_SM2_GEN_KEY, SM_R_EC_KEY_NEW_FAILED, 0);

    ret = EC_KEY_set_group(key, group);
    SM_ERROR_ESCAPE(ret == 0, SM_F_SM2_GEN_KEY, SM_R_EC_KEY_SET_GROUP_FAILED, 0);

    ret = EC_KEY_generate_key(key);
    SM_ERROR_ESCAPE(ret == 0, SM_F_SM2_GEN_KEY, SM_R_EC_KEY_GENERATE_KEY_FAILED, 0);

    ret = 1;

_err:
    if (ret == 0)
    {
        SM_RESOURCE_FREE(key, EC_KEY_free);
    }

    SM_RESOURCE_FREE(p, BN_free);
    SM_RESOURCE_FREE(a, BN_free);
    SM_RESOURCE_FREE(b, BN_free);
    SM_RESOURCE_FREE(z, BN_free);
    SM_RESOURCE_FREE(gx, BN_free);
    SM_RESOURCE_FREE(gy, BN_free);
    SM_RESOURCE_FREE(ctx, BN_CTX_free);
    SM_RESOURCE_FREE(group, EC_GROUP_free);
    SM_RESOURCE_FREE(point_p, EC_POINT_free);

    return key;
}
